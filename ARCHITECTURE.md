# ๐๏ธ Arquitetura do Sistema

## ๐ Visรฃo Geral

O Sistema de Obrigaรงรตes Fiscais segue uma arquitetura **cliente-servidor** com comunicaรงรฃo **RESTful** e **WebSocket** para tempo real.

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FRONTEND                            โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ       โ
โ  โ   React    โ  โ TailwindCSS  โ  โ FullCalendar โ       โ
โ  โ TypeScript โ  โ              โ  โ              โ       โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ       โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ  โ         Components & Services                โ         โ
โ  โ  - CalendarioFiscal                          โ         โ
โ  โ  - ObrigacaoModal                            โ         โ
โ  โ  - FiltrosPanel                              โ         โ
โ  โ  - API Service (Axios)                       โ         โ
โ  โ  - Socket Service (Socket.io-client)         โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ HTTP/REST + WebSocket
                            โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         BACKEND                             โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ       โ
โ  โ  Express   โ  โ  Socket.io   โ  โ   SQLite     โ       โ
โ  โ TypeScript โ  โ              โ  โ              โ       โ
โ  โโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ       โ
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โ  โ            Camadas da Aplicaรงรฃo              โ         โ
โ  โ                                              โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ  โ         Routes (Rotas)              โ    โ         โ
โ  โ  โ  - /api/obrigacoes                  โ    โ         โ
โ  โ  โ  - /api/feriados                    โ    โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ                    โ                        โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ  โ      Controllers (Lรณgica)          โ    โ         โ
โ  โ  โ  - ObrigacaoController              โ    โ         โ
โ  โ  โ  - FeriadoController                โ    โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ                    โ                        โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ  โ    Services (Regras de Negรณcio)    โ    โ         โ
โ  โ  โ  - RecorrenciaService               โ    โ         โ
โ  โ  โ  - FeriadoService                   โ    โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ                    โ                        โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โ  โ      Models (Acesso a Dados)       โ    โ         โ
โ  โ  โ  - ObrigacaoModel                   โ    โ         โ
โ  โ  โ  - Database                         โ    โ         โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โผ
                   โโโโโโโโโโโโโโโโโโโ
                   โ   BrasilAPI     โ
                   โ   (Feriados)    โ
                   โโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Padrรตes Arquiteturais

### Backend: MVC + Services

**Model-View-Controller** adaptado com camada de serviรงos:

1. **Routes**: Define endpoints da API
2. **Controllers**: Processa requests/responses HTTP
3. **Services**: Contรฉm lรณgica de negรณcio complexa
4. **Models**: Acesso e manipulaรงรฃo de dados

### Frontend: Component-Based

**Arquitetura de Componentes React**:

1. **Components**: UI reutilizรกvel
2. **Services**: Comunicaรงรฃo com backend
3. **Types**: Definiรงรตes TypeScript compartilhadas
4. **Hooks**: Lรณgica de estado e efeitos

## ๐ฆ Estrutura de Diretรณrios

### Backend
```
backend/
โโโ src/
โ   โโโ config/           # Configuraรงรตes (DB, etc)
โ   โ   โโโ database.ts
โ   โโโ controllers/      # Controllers HTTP
โ   โ   โโโ obrigacaoController.ts
โ   โ   โโโ feriadoController.ts
โ   โโโ models/           # Models de dados
โ   โ   โโโ obrigacaoModel.ts
โ   โโโ routes/           # Definiรงรฃo de rotas
โ   โ   โโโ index.ts
โ   โโโ services/         # Lรณgica de negรณcio
โ   โ   โโโ feriadoService.ts
โ   โ   โโโ recorrenciaService.ts
โ   โโโ types/            # TypeScript types
โ   โ   โโโ index.ts
โ   โโโ server.ts         # Entry point
โโโ database/             # SQLite database
โ   โโโ fiscal.db
โโโ package.json
โโโ tsconfig.json
```

### Frontend
```
frontend/
โโโ src/
โ   โโโ components/       # Componentes React
โ   โ   โโโ CalendarioFiscal.tsx
โ   โ   โโโ ObrigacaoModal.tsx
โ   โ   โโโ FiltrosPanel.tsx
โ   โ   โโโ NotificacaoRealTime.tsx
โ   โ   โโโ UsuariosOnline.tsx
โ   โโโ services/         # Serviรงos API
โ   โ   โโโ api.ts
โ   โ   โโโ socket.ts
โ   โโโ types/            # TypeScript types
โ   โ   โโโ index.ts
โ   โโโ App.tsx           # Componente raiz
โ   โโโ main.tsx          # Entry point
โ   โโโ index.css         # Estilos globais
โโโ public/
โโโ index.html
โโโ package.json
โโโ tsconfig.json
โโโ vite.config.ts
โโโ tailwind.config.js
```

## ๐ Fluxo de Dados

### 1. Criaรงรฃo de Obrigaรงรฃo

```
โโโโโโโโโโโโ   1. Evento    โโโโโโโโโโโโโโโโ
โ Frontend โ โโโโโโโโโโโโโ> โ ObrigacaoModalโ
โโโโโโโโโโโโ                โโโโโโโโโโโโโโโโ
                                    โ
                             2. onSave()
                                    โ
                                    โผ
                            โโโโโโโโโโโโโโโโ
                            โ   App.tsx    โ
                            โโโโโโโโโโโโโโโโ
                                    โ
                             3. API Call
                                    โ
                                    โผ
                            โโโโโโโโโโโโโโโโ
                            โ api.ts       โ
                            โ (Axios POST) โ
                            โโโโโโโโโโโโโโโโ
                                    โ
                             4. HTTP POST
                                    โ
                                    โผ
โโโโโโโโโโโโ                โโโโโโโโโโโโโโโโ
โ Backend  โ <โโโโโโโโโโโโโ โ Express      โ
โโโโโโโโโโโโ   5. Route     โโโโโโโโโโโโโโโโ
     โ
     โ 6. Controller
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ obrigacaoControllerโ
โโโโโโโโโโโโโโโโโโโโ
     โ
     โ 7. Validaรงรฃo + Service
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ feriadoService   โ (ajustar data)
โ recorrenciaServiceโ (validar)
โโโโโโโโโโโโโโโโโโโโ
     โ
     โ 8. Model
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ obrigacaoModel   โ
โ .criar()         โ
โโโโโโโโโโโโโโโโโโโโ
     โ
     โ 9. SQL INSERT
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ SQLite DB        โ
โโโโโโโโโโโโโโโโโโโโ
     โ
     โ 10. Return
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ Controller       โ
โโโโโโโโโโโโโโโโโโโโ
     โ
     โ 11. Emit Socket
     โผ
โโโโโโโโโโโโโโโโโโโโ
โ Socket.io        โ โโโโ
โโโโโโโโโโโโโโโโโโโโ    โ
                        โ 12. Broadcast
                        โผ
              โโโโโโโโโโโโโโโโโโโโ
              โ Todos os Clientesโ
              โ Conectados       โ
              โโโโโโโโโโโโโโโโโโโโ
                        โ
                        โ 13. Update UI
                        โผ
              โโโโโโโโโโโโโโโโโโโโ
              โ Frontend         โ
              โ (Auto refresh)   โ
              โโโโโโโโโโโโโโโโโโโโ
```

### 2. Colaboraรงรฃo em Tempo Real

```
Cliente A                 Servidor              Cliente B
    โ                         โ                     โ
    โ 1. Conecta WebSocket    โ                     โ
    โ โโโโโโโโโโโโโโโโโโโโโโโ>โ                     โ
    โ                         โ                     โ
    โ                         โ 2. Conecta          โ
    โ                         โ<โโโโโโโโโโโโโโโโโโโโโ
    โ                         โ                     โ
    โ                         โ 3. Broadcast        โ
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>โ
    โ   "user:connected"      โ                     โ
    โ                         โ                     โ
    โ 4. Cria Obrigaรงรฃo      โ                     โ
    โ โโโโโโโโโโโโโโโโโโโโโโโ>โ                     โ
    โ     HTTP POST           โ                     โ
    โ                         โ                     โ
    โ                         โ 5. Salva no DB      โ
    โ                         โ + Emit Socket       โ
    โ                         โ                     โ
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>โ
    โ 6. "obrigacao:created"  โ                     โ
    โ    (Todos recebem)      โ                     โ
    โ                         โ                     โ
    โ 7. Atualiza UI         โ 8. Atualiza UI      โ
    โ                         โ                     โ
```

## ๐ APIs e Integraรงรตes

### API REST (Express)

**Base URL**: `http://localhost:3001/api`

| Mรฉtodo | Endpoint | Descriรงรฃo |
|--------|----------|-----------|
| GET | `/obrigacoes` | Lista todas |
| GET | `/obrigacoes/:id` | Busca por ID |
| GET | `/obrigacoes/filtrar` | Filtra com query params |
| POST | `/obrigacoes` | Cria nova |
| PUT | `/obrigacoes/:id` | Atualiza |
| DELETE | `/obrigacoes/:id` | Remove |
| GET | `/obrigacoes/:id/historico` | Histรณrico |
| POST | `/obrigacoes/:id/gerar-proxima` | Gera prรณxima recorrรชncia |
| GET | `/feriados/:ano` | Lista feriados |
| POST | `/feriados/ajustar-data` | Ajusta data |

### WebSocket (Socket.io)

**URL**: `ws://localhost:3001`

**Eventos do Servidor โ Cliente:**
- `obrigacao:created`
- `obrigacao:updated`
- `obrigacao:deleted`
- `user:connected`
- `user:disconnected`
- `users:list`
- `obrigacao:being-edited`
- `obrigacao:editing-stopped`

**Eventos do Cliente โ Servidor:**
- `user:register`
- `obrigacao:editing`
- `obrigacao:stop-editing`
- `obrigacao:change`

### API Externa

**BrasilAPI** - Feriados Nacionais
- URL: `https://brasilapi.com.br/api/feriados/v1/{ano}`
- Cache: 24 horas
- Fallback: Banco de dados local

## ๐พ Modelo de Dados

### Tabela: obrigacoes
```sql
CREATE TABLE obrigacoes (
  id TEXT PRIMARY KEY,
  titulo TEXT NOT NULL,
  descricao TEXT,
  dataVencimento TEXT NOT NULL,
  dataVencimentoOriginal TEXT NOT NULL,
  tipo TEXT NOT NULL,
  status TEXT NOT NULL,
  cliente TEXT,
  empresa TEXT,
  responsavel TEXT,
  ajusteDataUtil INTEGER NOT NULL DEFAULT 1,
  cor TEXT,
  criadoEm TEXT NOT NULL,
  atualizadoEm TEXT NOT NULL,
  criadoPor TEXT
)
```

### Tabela: recorrencias
```sql
CREATE TABLE recorrencias (
  obrigacaoId TEXT PRIMARY KEY,
  tipo TEXT NOT NULL,
  intervalo INTEGER,
  diaDoMes INTEGER,
  dataFim TEXT,
  proximaOcorrencia TEXT,
  FOREIGN KEY (obrigacaoId) REFERENCES obrigacoes(id)
)
```

### Tabela: historico
```sql
CREATE TABLE historico (
  id TEXT PRIMARY KEY,
  obrigacaoId TEXT NOT NULL,
  usuario TEXT NOT NULL,
  tipo TEXT NOT NULL,
  camposAlterados TEXT,
  timestamp TEXT NOT NULL,
  FOREIGN KEY (obrigacaoId) REFERENCES obrigacoes(id)
)
```

### Tabela: feriados
```sql
CREATE TABLE feriados (
  data TEXT PRIMARY KEY,
  nome TEXT NOT NULL,
  tipo TEXT NOT NULL
)
```

## ๐ Seguranรงa

### Backend
- โ CORS configurado para frontend especรญfico
- โ Validaรงรฃo de entrada em todos os endpoints
- โ Prepared statements (SQL injection protection)
- โ Error handling centralizado
- โ Logs estruturados

### Frontend
- โ Type safety com TypeScript
- โ Sanitizaรงรฃo de dados antes de envio
- โ Validaรงรฃo de formulรกrios
- โ Tratamento de erros de API

### Melhorias Futuras
- ๐ Autenticaรงรฃo JWT
- ๐ Rate limiting
- ๐ HTTPS obrigatรณrio
- ๐ Criptografia de dados sensรญveis

## ๐ Performance

### Backend
- โ รndices no banco de dados
- โ Cache de feriados (NodeCache)
- โ Queries otimizadas
- โ Connection pooling (SQLite)

### Frontend
- โ Code splitting com Vite
- โ Lazy loading de componentes
- โ Debounce em filtros
- โ Memoizaรงรฃo de componentes pesados

### WebSocket
- โ Reconnection automรกtica
- โ Heartbeat para manter conexรฃo
- โ Broadcast eficiente (rooms)

## ๐ Monitoramento

### Logs
- โ Conexรตes/desconexรตes
- โ Erros capturados
- โ Operaรงรตes CRUD
- โ Performance de queries

### Health Check
- Endpoint: `GET /health`
- Retorna status do servidor e timestamp

---

Esta arquitetura foi projetada para ser:
- โ **Escalรกvel**: Fรกcil adicionar novos recursos
- โ **Manutenรญvel**: Cรณdigo organizado e limpo
- โ **Testรกvel**: Camadas desacopladas
- โ **Performรกtica**: Otimizaรงรตes em todas as camadas

