# üêò Guia de Configura√ß√£o Supabase - Sistema Fiscal

Este guia ir√° ajud√°-lo a configurar o Supabase (PostgreSQL) como banco de dados para o Sistema Fiscal.

---

## üìã Pr√©-requisitos

- Conta no Supabase ([criar conta gratuita](https://supabase.com))
- Projeto criado no Supabase
- Node.js instalado no sistema

---

## üöÄ Instala√ß√£o R√°pida

### 1. Criar Projeto no Supabase

1. Acesse [supabase.com](https://supabase.com)
2. Fa√ßa login ou crie uma conta
3. Clique em "New Project"
4. Preencha:
   - **Nome**: Sistema Fiscal
   - **Database Password**: Crie uma senha forte
   - **Region**: Escolha a regi√£o mais pr√≥xima (Brasil: South America - S√£o Paulo)
5. Aguarde a cria√ß√£o do projeto (~2 minutos)

### 2. Executar Script SQL

1. No dashboard do Supabase, v√° em **SQL Editor**
2. Clique em **New Query**
3. Cole o conte√∫do do arquivo `database_supabase.sql`
4. Clique em **Run** (ou pressione Ctrl+Enter)

**OU** execute via linha de comando:

```bash
# Instalar CLI do Supabase
npm install -g supabase

# Login no Supabase
supabase login

# Vincular ao seu projeto
supabase link --project-ref seu-project-ref

# Executar migra√ß√£o
supabase db push
```

### 3. Instalar Depend√™ncias do Backend

```bash
cd backend
npm install pg @supabase/supabase-js
```

### 4. Configurar Vari√°veis de Ambiente

Crie um arquivo `.env` na pasta `backend/`:

```env
# Banco de Dados Supabase
DB_TYPE=supabase
SUPABASE_URL=https://seu-project-ref.supabase.co
SUPABASE_KEY=sua-anon-key-aqui
SUPABASE_SERVICE_KEY=sua-service-role-key-aqui

# Servidor
PORT=3001
NODE_ENV=production
```

**Onde encontrar as chaves:**
- No Supabase Dashboard ‚Üí **Settings** ‚Üí **API**
- **Project URL** ‚Üí `SUPABASE_URL`
- **anon public key** ‚Üí `SUPABASE_KEY`
- **service_role secret** ‚Üí `SUPABASE_SERVICE_KEY`

---

## üìù Instru√ß√µes Detalhadas

### Op√ß√£o A: Via Supabase Dashboard (Recomendado)

1. **Acesse o SQL Editor**
   - No menu lateral do Supabase
   - Clique em "SQL Editor"

2. **Criar Nova Query**
   - Clique em "New Query"
   - D√™ um nome (ex: "Setup Sistema Fiscal")

3. **Cole e Execute o Script**
   - Copie todo o conte√∫do de `database_supabase.sql`
   - Cole no editor
   - Clique em **Run** (ou Ctrl+Enter)

4. **Verificar Execu√ß√£o**
   - Deve aparecer "Success. No rows returned"
   - Verifique a aba "Table Editor" para ver as tabelas criadas

### Op√ß√£o B: Via Supabase CLI

```bash
# 1. Instalar CLI
npm install -g supabase

# 2. Login
supabase login

# 3. Inicializar projeto local (opcional)
supabase init

# 4. Vincular ao projeto remoto
supabase link --project-ref seu-project-ref

# 5. Executar script SQL
supabase db execute -f database_supabase.sql
```

### Op√ß√£o C: Via Arquivo SQL

```bash
# Copiar arquivo para o projeto local do Supabase
cp database_supabase.sql supabase/migrations/YYYYMMDDHHMMSS_create_tables.sql

# Aplicar migra√ß√£o
supabase db push
```

---

## ‚öôÔ∏è Configura√ß√£o Avan√ßada

### Atualizar database.ts

Atualize o arquivo `backend/src/config/database.ts`:

```typescript
import { createClient } from '@supabase/supabase-js';
import sqlite3 from 'sqlite3';
import { join } from 'path';
import { existsSync, mkdirSync } from 'fs';

const dbType = process.env.DB_TYPE || 'sqlite';

let supabaseClient: any;

if (dbType === 'supabase') {
  supabaseClient = createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_KEY!
  );
}

export async function getDatabase() {
  if (dbType === 'supabase') {
    return supabaseClient;
  } else {
    // SQLite (padr√£o para desenvolvimento)
    const DB_DIR = join(__dirname, '../../database');
    const DB_PATH = join(DB_DIR, 'fiscal.db');
    
    if (!existsSync(DB_DIR)) {
      mkdirSync(DB_DIR, { recursive: true });
    }
    
    return new sqlite3.Database(DB_PATH);
  }
}

// Wrapper para compatibilidade com SQLite
export default {
  run: async (sql: string, params: any[] = []) => {
    if (dbType === 'supabase') {
      // Para PostgreSQL, use query() diretamente
      const { error } = await supabaseClient.rpc('execute_sql', { sql_query: sql });
      if (error) throw error;
      return { changes: 1, lastID: 0 };
    } else {
      // SQLite
      return new Promise((resolve, reject) => {
        (getDatabase() as any).run(sql, params, function(err: any) {
          if (err) reject(err);
          else resolve({ changes: this.changes, lastID: this.lastID });
        });
      });
    }
  },
  get: async (table: string, filters: any = {}) => {
    if (dbType === 'supabase') {
      const { data, error } = await supabaseClient
        .from(table)
        .select('*')
        .match(filters)
        .single();
      if (error) throw error;
      return data;
    } else {
      // Implementar para SQLite
      return null;
    }
  },
  all: async (table: string, filters: any = {}) => {
    if (dbType === 'supabase') {
      const { data, error } = await supabaseClient
        .from(table)
        .select('*')
        .match(filters);
      if (error) throw error;
      return data || [];
    } else {
      // Implementar para SQLite
      return [];
    }
  }
};
```

---

## üîç Verifica√ß√£o

### Testar Conex√£o

Execute no SQL Editor do Supabase:

```sql
-- Ver tabelas criadas
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Deve retornar 7 tabelas
```

### Verificar Dados

```sql
-- Ver clientes inseridos
SELECT * FROM clientes;

-- Ver obriga√ß√µes de exemplo
SELECT * FROM obrigacoes;

-- Ver estat√≠sticas gerais
SELECT * FROM sp_estatisticas_gerais();

-- Ver pr√≥ximas obriga√ß√µes
SELECT * FROM vw_proximas_obrigacoes;
```

### Testar via Dashboard

1. Acesse **Table Editor** no menu lateral
2. Deve ver todas as tabelas criadas
3. Clique em qualquer tabela para ver os dados

---

## üéØ Recursos Espec√≠ficos do Supabase

### 1. Real-time Subscriptions

```typescript
// Exemplo: Escutar mudan√ßas em tempo real
const subscription = supabase
  .channel('obrigacoes')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'obrigacoes' },
    (payload) => {
      console.log('Mudan√ßa detectada:', payload);
    }
  )
  .subscribe();
```

### 2. Autentica√ß√£o (Row Level Security)

Se quiser habilitar autentica√ß√£o de usu√°rios:

```sql
-- Habilitar RLS
ALTER TABLE obrigacoes ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica: Usu√°rios podem ver apenas seus pr√≥prios dados
CREATE POLICY "Users can view own obligations" 
ON obrigacoes FOR SELECT 
USING (auth.uid()::text = created_by);

-- Pol√≠tica: Usu√°rios podem inserir suas pr√≥prias obriga√ß√µes
CREATE POLICY "Users can insert own obligations" 
ON obrigacoes FOR INSERT 
WITH CHECK (auth.uid()::text = created_by);
```

### 3. Storage (para documentos)

```typescript
// Upload de arquivo
const { data, error } = await supabase.storage
  .from('documentos')
  .upload('relatorio.pdf', file);

// Download
const { data, error } = await supabase.storage
  .from('documentos')
  .download('relatorio.pdf');
```

### 4. Edge Functions

Para criar fun√ß√µes serverless:

```typescript
// supabase/functions/send-email/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  const { email, subject, body } = await req.json()
  // Enviar email
  return new Response(JSON.stringify({ success: true }))
})
```

---

## üîß Troubleshooting

### Erro: "relation does not exist"

**Solu√ß√£o**: Execute o script SQL novamente e verifique se todas as tabelas foram criadas.

```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';
```

### Erro: "column does not exist"

**Solu√ß√£o**: Verifique se os nomes das colunas est√£o corretos (PostgreSQL √© case-sensitive).

### Erro de Conex√£o

**Solu√ß√£o**: Verifique:
1. URL do Supabase est√° correta
2. Chave API est√° correta
3. Firewall permite conex√µes do Supabase

### Erro: "permission denied"

**Solu√ß√£o**: Verifique permiss√µes do usu√°rio:

```sql
-- Ver permiss√µes
SELECT grantee, privilege_type 
FROM information_schema.role_table_grants 
WHERE table_name = 'obrigacoes';
```

### RLS Bloqueando Consultas

**Solu√ß√£o**: Se habilitou RLS, crie pol√≠ticas adequadas ou desabilite temporariamente:

```sql
ALTER TABLE obrigacoes DISABLE ROW LEVEL SECURITY;
```

---

## üìä Utilidades

### Views Criadas

```sql
-- Obriga√ß√µes por cliente
SELECT * FROM vw_obrigacoes_por_cliente;

-- Pr√≥ximas obriga√ß√µes (30 dias)
SELECT * FROM vw_proximas_obrigacoes;

-- Parcelamentos resumidos
SELECT * FROM vw_parcelamentos_resumo;
```

### Functions

```sql
-- Atualizar obriga√ß√µes atrasadas
SELECT sp_atualizar_obrigacoes_atrasadas();

-- Obter obriga√ß√µes por per√≠odo
SELECT * FROM sp_obrigacoes_por_periodo('2024-01-01', '2024-12-31');

-- Estat√≠sticas gerais
SELECT * FROM sp_estatisticas_gerais();
```

### Backup

O Supabase faz backup autom√°tico diariamente. Para backup manual:

```bash
# Via CLI
supabase db dump -f backup.sql

# Via Dashboard
Settings ‚Üí Database ‚Üí Backups ‚Üí Manual Backup
```

---

## üîê Seguran√ßa

### 1. Vari√°veis de Ambiente

**NUNCA** commite as chaves do Supabase no Git:

```bash
# .env (adicionar ao .gitignore)
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# .env.example (exemplo seguro)
SUPABASE_KEY=your_supabase_key_here
```

### 2. Row Level Security

Para produ√ß√£o, sempre habilite RLS:

```sql
-- Habilitar RLS em todas as tabelas
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;
ALTER TABLE obrigacoes ENABLE ROW LEVEL SECURITY;
-- ... etc
```

### 3. API Keys

- Use `SUPABASE_KEY` (anon) no frontend
- Use `SUPABASE_SERVICE_KEY` apenas no backend
- Nunca exponha a service key publicamente

### 4. HTTPS

O Supabase j√° for√ßa HTTPS, mas configure dom√≠nio customizado em produ√ß√£o:

```
Settings ‚Üí Authentication ‚Üí URL Configuration
```

---

## üìà Performance

### √çndices

O script j√° cria √≠ndices otimizados. Verifique se foram criados:

```sql
SELECT 
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

### Query Performance

Use `EXPLAIN ANALYZE` para otimizar queries:

```sql
EXPLAIN ANALYZE
SELECT * FROM obrigacoes WHERE cliente_id = 1;
```

### Connection Pooling

O Supabase j√° tem connection pooling ativado. Use:

```
postgres://[PROJECT_REF]:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:6543/postgres
```

---

## üîÑ Migra√ß√£o SQLite ‚Üí Supabase

Consulte a se√ß√£o de **Migra√ß√£o de Dados** no arquivo [DATABASE.md](DATABASE.md).

---

## üí∞ Custos

### Plano Gratuito (Hobby)

- ‚úÖ 500 MB de banco de dados
- ‚úÖ 2 GB de storage
- ‚úÖ 2 GB de bandwidth
- ‚úÖ API ilimitada

### Quando fazer upgrade:

- > 500 MB de dados
- Precisa de backup mais longo que 7 dias
- Precisa de mais de 1 projeto

---

## üìû Suporte

- üìñ [Documenta√ß√£o Supabase](https://supabase.com/docs)
- üí¨ [Discord Supabase](https://discord.supabase.com)
- üêõ [Issues no GitHub](../../issues)
- üìß Suporte por email (planos pagos)

---

## üîó Links √öteis

- [Supabase Dashboard](https://app.supabase.com)
- [Supabase CLI Docs](https://supabase.com/docs/guides/cli)
- [PostgreSQL Docs](https://www.postgresql.org/docs/)
- [PostgREST API](https://postgrest.org/)

---

**Desenvolvido com ‚ù§Ô∏è para o Sistema Fiscal**

